# Invoice System Setup Guide

## Step 1: Create the `invoices` table in Supabase

Go to your Supabase project dashboard and create a new table with the following SQL:

```sql
CREATE TABLE invoices (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  resident_id TEXT NOT NULL REFERENCES residents(id) ON DELETE CASCADE,
  file_name TEXT NOT NULL,
  file_path TEXT NOT NULL,
  file_url TEXT NOT NULL,
  file_size INTEGER,
  file_type TEXT,
  uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create index for faster lookups by resident_id
CREATE INDEX invoices_resident_id_idx ON invoices(resident_id);
```

Or use the Supabase UI:

1. Go to **SQL Editor** → **New Query**
2. Copy and paste the SQL above
3. Click **Run**

## Step 2: Enable Row Level Security (RLS)

To make invoices publicly downloadable but only by those with the resident link:

```sql
-- Enable RLS
ALTER TABLE invoices ENABLE ROW LEVEL SECURITY;

-- Allow anyone to read invoices (public downloads)
CREATE POLICY "Allow public read" ON invoices
  FOR SELECT USING (true);

-- Allow anonymous uploads via API (we use anon key)
CREATE POLICY "Allow insert for anonymous" ON invoices
  FOR INSERT WITH CHECK (true);

-- Allow deletion
CREATE POLICY "Allow delete for all" ON invoices
  FOR DELETE USING (true);
```

## Step 3: Enable Supabase Storage

If you haven't already created the `invoices` storage bucket:

1. Go to **Storage** in Supabase dashboard
2. Click **Create new bucket**
3. Name it: `invoices`
4. Make it **Public** (uncheck "Private bucket")
5. Click **Create bucket**

## Step 4: Update Storage Policies

Set the storage bucket policy to allow uploads:

```sql
-- Allow public uploads to invoices bucket
INSERT INTO storage.buckets (id, name, public) VALUES ('invoices', 'invoices', true);

-- Set policy to allow anyone to upload
CREATE POLICY "Allow public uploads" ON storage.objects
  FOR INSERT WITH CHECK (bucket_id = 'invoices');

-- Set policy to allow public downloads
CREATE POLICY "Allow public downloads" ON storage.objects
  FOR SELECT USING (bucket_id = 'invoices');
```

Or use the Supabase UI:
1. Go to **Storage** → **invoices** bucket
2. Click **Policies** → **New policy**
3. Select **For full customization, use SQL editor** 
4. Use the policies above

## Features Now Available

### Admin View
- **Upload Invoice**: Button in each resident's card to upload invoices
- Accepts: PDF, JPG, PNG
- Automatically creates database records with metadata
- **Notify About Invoice**: "Paziņot" button to send email notification to resident about their latest invoice
  - Sends email with direct download link to the invoice
  - Includes link to resident view to see all invoices
  - Only enabled for residents with email addresses

### Resident View  
- **View Invoices**: Shows "Display Invoices" button
- Lists all invoices uploaded for that resident
- Shows file name and upload date
- **Download**: One-click download with original file name

## Invoice Table Structure

| Column | Type | Notes |
|--------|------|-------|
| id | BIGINT | Auto-generated primary key |
| resident_id | TEXT | FK to residents.id |
| file_name | TEXT | Original filename |
| file_path | TEXT | Path in storage (invoices/...) |
| file_url | TEXT | Public download URL |
| file_size | INTEGER | File size in bytes |
| file_type | TEXT | MIME type (application/pdf, etc.) |
| uploaded_at | TIMESTAMP | When file was uploaded |
| created_at | TIMESTAMP | Record creation time |

## Testing

1. Go to Admin View
2. Find a resident card
3. Click **Augšupielādēt rēķinu** (Upload Invoice)
4. Select a PDF/JPG/PNG file
5. Click **Augšupielādēt** (Upload)
6. Click **Paziņot** (Notify) button to send email notification to resident
7. Go to Resident View (using resident link)
8. Click **Parādīt rēķinus** (Display Invoices)
9. Click **Lejupielādēt** (Download) to test download

## Deploy Edge Functions

You need to deploy TWO Edge Functions to Supabase:

### 1. Deploy send-invoice-notification function

```bash
cd /home/zhuk/work/water-meters-app
supabase functions deploy send-invoice-notification
```

Make sure you have set the environment secrets in Supabase:
- `RESEND_API_KEY` - Your Resend API key
- `APP_URL` - Your app URL (e.g., https://your-app.netlify.app)

### 2. Verify send-reminder-emails function is deployed

This should already be deployed from earlier, but verify:

```bash
supabase functions list
```

Both functions should appear in the list.

## Troubleshooting

**Uploads fail with 403 error:**
- Check RLS policies are enabled for invoices table
- Verify storage bucket policies allow uploads

**Downloads fail:**
- Verify storage bucket policies allow public reads
- Check that file_url is correctly formed

**Invoices don't appear in resident view:**
- Make sure invoices table has the right resident_id
- Check RLS policies allow SELECT on invoices table
